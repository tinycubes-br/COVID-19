#include <stdlib.h>
#include "metadata.h"
#include "register.h"
#include "query.h"

void xprintf(char *fmt,...) {
#if 1
    return;
#else
    va_list args;

    va_start(args, fmt);
    vprintf(fmt, args);
    va_end(args);
#endif    
}  

void *xcalloc(size_t n, size_t size) {
    void *p = calloc(n, size);
    if (!p) fatal("calloc");
    return p;
}


#define __USE_HASH_FREE_LIST__NO

#ifdef __USE_HASH_FREE_LIST__
//=============================================================================================
//
//    Hash Free List
//
//=============================================================================================

typedef struct s_x {
	struct s_x * next;
} FreeListItem, *PFreeListItem;

typedef struct {
    int size;
	int n;
	struct s_x *first;
} FreeList, *PFreeList;

#define MAX_FREELIST_ITEMS 1000

static void* freelist_alloc(PFreeList pfl, int size) {
	if (!pfl->n) return calloc(1,size);
	PFreeListItem pfli = pfl->first;
	pfl->first = pfli->next;
	pfl->n --;
	return pfli;
}

static  void freelist_free(PFreeList pfl, void *data) {
	PFreeListItem pfli = data;
	if (pfl->n == MAX_FREELIST_ITEMS) {
		free(data);
		return;
	}
	
	pfli->next = pfl->first;
	pfl->first = data;
	pfl->n ++;
}

#define HASH_SIZE 33
static FreeList hash[HASH_SIZE];

static int init = 0;

static void* hash_alloc(int size) {
	if (!init) {
        memset(hash,0,sizeof(hash));
        init = 1;
    }
	int h = (size * 47) % HASH_SIZE;
	PFreeList p = hash + h;
    if (p->size != size) {
        if (!p->size) {
            p->size = size;
        } else {
            fatal("colision");
        }
    } 
	return freelist_alloc(p, size);
}

static void hash_free(void *data, int size) {
	int h = (size * 47) % HASH_SIZE;
	PFreeList p = hash + h;
	freelist_free(p, data);
}
#endif



#define __USE_POOL__NO

//=============================================================================================
//
//    
//
//=============================================================================================

#ifdef __USE_POOL__
#define POOL_STEP 4096

typedef struct s_free_item {
    void *next;
} FreeNode, *PFreeItem;

typedef struct s_block {
    struct s_block *next;
    int   offset_next_free;
    int   free_tail;
} Block, *PBlock;

typedef struct s_pool {
    PFreeItem *freelist;

    int item_size;
    int nodes_per_block;

    int n_blocks;
    PBlock blocks;
} Pool, *PPool;

// Inicializa o Pool
static Pool pool =  { NULL, 0, 0, 0, NULL};

//-----------------------
//
//
//
//
static void release_pool(void) {
    PBlock p, q;
    for (p = pool.blocks; p; p = q) {
        q = p->next;
        free(p);
    }
    memset(&pool, 0, sizeof(Pool));
}

//-----------------------
//
//
//
//
static PBlock alloc_block(PPool pp) {
    int sz = sizeof(Block) + pp->item_size * pp->nodes_per_block;
    PBlock pb = malloc(sz);
    
    content_total_alocado += sz;

    if (!pb) fatal("BinList: allocation");

    pb->free_tail = pp->nodes_per_block;
    pb->offset_next_free = sizeof(Block);
    //xprintf("Size: %d, Free: %d Offset: %d\n",sz,pb->free_tail, pb->offset_next_free); fflush(stdout);
    return pb;
}

//-----------------------
//
//
//
//
static void *pool_alloc(int item_size) {
    PPool pp = &pool;
    void *res;

    if (!pp->item_size) {
        pp->item_size = item_size;
        pp->nodes_per_block = POOL_STEP;
        pp->blocks = alloc_block(pp);

    } else if (pp->item_size != item_size) {
        fatal("pool item size");
    }

    PBlock pb = NULL;

    // aloca da lista livre primeiro
    res = pp->freelist;
    if (res) {
        pp->freelist = ((PFreeItem) res)->next;

    // nao tem espaco no final 
    } else {
        if (!pp->blocks->free_tail) {
            // aloca um novo bloco 
            pb = alloc_block(pp); 
            pb->next = pp->blocks;
            pp->blocks = pb;
            //xprintf("New ");
        } else {
            pb  = pp->blocks;
            //xprintf("Current ");

        }
        res = ((char *) pb) + pb->offset_next_free;
        pb->offset_next_free += pp->item_size;
        pb->free_tail --;
        //xprintf("Item size: %d, Free: %d Offset: %d\n",pp->item_size,pb->free_tail, pb->offset_next_free); fflush(stdout);
    }

    // limpa
    memset(res,0,pp->item_size);
    return res;
}

#endif

//=============================================================================================
//
//    
//
//=============================================================================================

typedef struct s_bnode *PBinNode;
#define SHORT_BIN

#ifdef SHORT_BIN
typedef unsigned short bin_t;
#else
typedef unsigned int bin_t;
#endif

#define __INSERT_ONLY__


typedef struct __attribute__((__packed__))  s_bitem {
    bin_t id_bin;
    Byte data [];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
} BinItem, *PBinItem;

typedef struct __attribute__((__packed__))  s_bnode {
    struct s_bnode  *next_bin;
    //int tmp_n;
    // last_used;
    BinItem   items[0];
} BinNode;

typedef struct __attribute__((__packed__)) s_bin_list{
    PBinNode first; 
    PBinNode last;
    struct {
        __uint64_t   count    :32;         // up to 
        unsigned int bin_size :14;         // up to 
        unsigned int data_size :9;         // up to 
        unsigned int shallow   :1;         // up to 
        unsigned int last_node_n_items: 4; // 
        unsigned int items_per_node: 4;    // 
    } data;
    int n_items;
} BinList, *PBinList;

typedef struct {
    unsigned int list_bin_size;
} BParams, *PBinListParams;

#define MAX_ITEMS_PER_NODE  16
#define COMPUTE_NODE_SIZE(ITEM, N) (sizeof(BinNode) + ((ITEM) * (N)))


//=============================================================================================
//
//    Compact Array
//
//=============================================================================================

typedef struct  __attribute__((__packed__)) {
    struct {
        __uint64_t   n        :33;         // up to 
        unsigned int bin_size :13;         // up to 
        unsigned int data_size :9;         // up to 
    } data;
    char items[0];
} CompactArray, *PCompactArray;

static PCompactArray list_to_compact_array(PBinList pbl) {

    int item_size = sizeof(bin_t) + pbl->data.data_size;
    int n = pbl->n_items;
    
    PCompactArray pca = calloc(1,sizeof(CompactArray) + n * item_size);

    pca->data.n = n;
    pca->data.bin_size = pbl->data.bin_size;
    pca->data.data_size = pbl->data.data_size;

    char *items = pca->items; 

   // retira o retorno sobre o ultimo
    pbl->last->next_bin = NULL;
    PBinNode p, next;
    for (p = pbl->first; p; p = next) {
        int n = (p != pbl->last) ? MAX_ITEMS_PER_NODE : pbl->data.last_node_n_items;
        int items_size = item_size * n;

        //xprintf("  SHALLOW %p  Items size:%d\n",q,items_size);

        // deveria fazer um shallow copy recursivo
        memcpy(items,p->items,items_size);
        items += items_size;

        next = p->next_bin;
        free(p);
    }
    free(pbl);
    return pca;
}


//=============================================================================================
//
//    Content
//
//=============================================================================================

typedef struct s_content {
    union {
        PBinList      pbl;
        PCompactArray pca;
    } p;
    int bin_size;
    struct s_content *next;
} Content, *PContent;

PContent lists;


void compact_bin_list(void) {
    PContent p = lists;
    for (; p; p = p->next) {
        if (!p->p.pbl->data.shallow) {
            p->p.pca = list_to_compact_array(p->p.pbl);
        }
    }
}



#ifdef __HIST__    
int total_n_nodes = 0;
int max_blist_n_nodes = 0;
#endif

#ifdef __HIST__
int hist[25001];
#endif

static Byte shallow_data[1024];
static int count = 0;


__int64_t count_items[MAX_ITEMS_PER_NODE+1] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

//        int node_size = sizeof(BinNode) + item_size;
static int map_n_items[MAX_ITEMS_PER_NODE+1]  = { 1, 1, 2, 3, 4, 6, 6, 8, 8, 10, 10, 12, 12, 16, 16, 16, 16 };

//-----------------------
//
//
//
PBinList get_pbin_lists(PContent pc) {   
    if (pc->p.pbl) return pc->p.pbl;
    pc->p.pbl =  calloc(1,sizeof(BinList));
    pc->p.pbl->data.bin_size = pc->bin_size;
    pc->next = lists;
    lists = pc;
    return pc->p.pbl;
}

#define MAX_COUNT_ 1000

void check_pbi(void *pbi, int item_size, int n) {
    char *s;
    PBinItem p;

    int i;
    int prev = 0;
    for (i=0, p=pbi; i<n; i++, s+= item_size) {
        p = (PBinItem) s;
        if (p->id_bin) fatal("dkj");
    }
}

///-----------------------
//
//
//
//
static void *binlist_insert(PRecord record, void *data, PContentData pcd) {
    PContent pc = (PContent) data;
    PBinList pbl = get_pbin_lists(pc);
    PBinListParams pblp = (PBinListParams) pcd->params;
    PBinItem pbi;

    pbl->data.count ++;
    
    if (pbl->data.bin_size != pblp->list_bin_size) 
        fatal("BIN_SIZE: [%p %d] != [%p %d]", pbl, pbl->data.bin_size, pblp, pblp->list_bin_size);

    // sinaliza que os dados foram compartilhados
    if (pbl->data.shallow) return &shallow_data;

    __int64_t value0 = get_record_value(record, pcd, 0);
    __int64_t value = value0 /  pblp->list_bin_size;
#ifdef SHORT_BIN
    if (value > __UINT16_MAX__) fatal("BINLINST: overflow\n");
#endif    
    bin_t id_bin = (bin_t) value;

    id_bin ++; // reserva o valor zero

    PBinNode p = pbl->last;
    int item_size = sizeof(bin_t) + pbl->data.data_size;

    // xprintf("pbl = %p  l = %p\n", pbl, p);
    // Primeiro node?
    if (!p) {
        //xprintf("BINLIST: Primeiro %p\n",p);
        // configura a lista
        pbl->data.data_size = pcd->total_data_size;
        pbl->data.last_node_n_items = 1;
    
    // ja existem nodes na lista
    } else {
        int i, j, n;
        //nt realloc = 0;

alocate_in_last_node:
        n = pbl->data.last_node_n_items;

        xprintf("BINLIST: Nao Primeiro. N=%d\n", n);
        // if (p->tmp_n != n) { fatal("ERRO %d %d", n, p->tmp_n); }
        
        for (i=n, j=0, pbi = p->items; i; i--, j++) {
            
            //printf("BINLIST: %p value: %ld  target= %d found id_bin = %d  \n", p, value, id_bin, pbi->id_bin);

            if (id_bin == pbi->id_bin) {
                //xprintf("EXACT\n");
                return pbi->data;
#define PTR_OFFSET(PTR,OFFSET) ( ((char *) (PTR)) + (OFFSET) )

            } else if (id_bin < pbi->id_bin) {
                //fatal("Backwarding is not allowed in container binlist_addonly! P=%p id_bin=%d pbi->id_bin=%d j=%d n=%d tmp_n=%d  Realloc=%d ItemSize=%d, %p, %p Id[0] %d1 Id[1] %d LastUsed %d",
                //p, id_bin, pbi->id_bin, j, n, p->tmp_n, realloc, 
                //item_size,p->items, pbi, p->items[0].id_bin,  ((PBinItem) PTR_OFFSET(p->items,item_size)) ->id_bin, p->last_used );
                fatal("110");
            
            // achou um slot vago
            } else if (pbi->id_bin == 0) {
                //printf("NEW! Old=%d  New=%d\n",pbi->id_bin, id_bin);
                count_items[j-1]--;
                count_items[j]++;
                pbi->id_bin = id_bin;
                pbl->n_items ++;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return pbi->data;
            }
            pbi = (PBinItem) (((char *) pbi) +  item_size); 
        }

        // se chegou aqui, ento nao tem mais espaco
        //xprintf("Espao esgotado.\n");


        // verifica se pode crescer
        if (n+1 >= MAX_ITEMS_PER_NODE) {
            //xprintf("Nao pode crescer P=%p\n",p);
        } else {
            int old_node_size = COMPUTE_NODE_SIZE(item_size, n);
            n = map_n_items[n+1];
            int new_node_size = COMPUTE_NODE_SIZE(item_size, n);
            //printf("Relocando... P=%p  Last=%p, LastNItems=%d N=%d New=%d Old=%d\n",p, pbl->last,pbl->data.last_node_n_items,n,new_node_size,old_node_size);
            
            // aloca novo node
            PBinNode new = calloc(1,new_node_size);

            // copia o conteudo antigo para o novo
            memcpy(new, p, old_node_size);

            //xprintf("Free %p\n",p);
            //fflush(stdout);

            // libera o node anterior
#ifdef __USE_HASH_FREE_LIST__
            hash_free(p, old_node_size);
#else 
            free(p);
#endif
            // agora p tem o novo node
            p = new;
            //p->tmp_n = n; 

            // no ultimo elemento next_bin aponta para o anterior 
           if (!p->next_bin) {
//            if (!pbl->first) {
                pbl->first = p;
            } else {
                p->next_bin->next_bin = p; 
            }

            // atualiza o last
            pbl->last = p;

            // atualiza o numero de itens no ultimo node
            pbl->data.last_node_n_items = n;

            //xprintf("Relocado... P=%p  Last=%p, LastNItems=%d New=%d\n",p, pbl->last,pbl->data.last_node_n_items, node_size);
            //realloc = 1;
            goto alocate_in_last_node;
        }

        // nao encontrou no bloco. 
        // E nao tem espaco vazio Precisa alocar.

    }

    // allocates space to store subchannel data
    int node_size = sizeof(BinNode) + item_size;

    pbl->data.last_node_n_items = 1;

#ifdef __USE_POOL__    
    p = (PBinNode) pool_alloc(node_size);        
#else 
#ifdef __USE_HASH_FREE_LIST__
    p = (PBinNode) hash_alloc(node_size);
#else 
    p = (PBinNode) calloc(1, node_size);
    //p->tmp_n = 1; 
    //p->last_used = 1; 
    //xprintf("itemsize: %d, node_size:%d * %d\n",item_size,node_size,MAX_ITEMS_PER_NODE);     
#endif
#endif    
    // faz com que o novo node temporariamente aponte para o antigo
    p->next_bin = pbl->last;  // usa isso para corrigir a realocacao

    //xprintf("BINLIST: new id_bin %d  %ld  %p\n", id_bin, value, pbl);
    //xprintf("Alocando... P=%p  Last=%p, LastNItems=%d\n",p, pbl->last,pbl->data.last_node_n_items);

    pbi = p->items;
    count_items[0] ++;

    pbi->id_bin = id_bin;
    //xprintf("BINLIST: %p New Node id_bin %d %d \n", p, pbi->id_bin, id_bin);

    // encadeia no final da lista
    if (!pbl->last) { 
        pbl->first = p; 
    } else { 
        pbl->last->next_bin = p; 
    } 
    pbl->last = p;
    pbl->n_items ++;

#ifdef MAX_COUNT
    count ++;
    if (count > MAX_COUNT) fatal("finished");
#endif

    return pbi->data;
}

//-----------------------
//
//
//
//
static void *binlist_remove(PRecord record, void *data, PContentData pcd) {
    return NULL;
}


//----------------------
//
//
//
//
static void _shallow_copy(PByte dst, PByte src, int n_bytes) {    
    PBinList s = ((PContent) src)->p.pbl;
    PBinList d = get_pbin_lists((PContent) dst);
    PBinNode p, q, d_prev;

    /*
    d->data.shallow = 1;
    return; 
    */

    memcpy(d,s,sizeof(BinList));
    d->data.shallow = 0;
    d->first = NULL;
    d->last = NULL;

    //xprintf("SHALLOW %p, N_Items=%d\n",d,s->data.last_node_n_items); fflush(stdout);
    
    int item_size = sizeof(bin_t) + s->data.data_size;
  //  int node_size;

    // retira o retorno sobre o ultimo
    PBinNode s_prev = s->last->next_bin;
    s->last->next_bin = NULL;

    for (p = s->first; p; p = p->next_bin) {
        int n = (p->next_bin) ? MAX_ITEMS_PER_NODE : s->data.last_node_n_items;
        int items_size = item_size * n;
        int node_size = sizeof(BinNode) + items_size;
#ifdef __USE_POOL__
        q = pool_alloc(dnode_size);
#else 
#ifdef __USE_HASH_FREE_LIST__
        q = hash_alloc(node_size);
#else
        q = calloc(1, node_size);
#endif 
#endif
        //xprintf("  SHALLOW %p  Items size:%d\n",q,items_size);

        //q->tmp_n = p->tmp_n;

        // deveria fazer um shallow copy recursivo
        memcpy(q->items, p->items, items_size);

        // ja foi copiado no memcpy
        // q->id_bin = p->id_bin;

        // faz com que o ultimo mais recente aponte para o item 
        q->next_bin = d->last;
        
        if (!d->last) { 
            d->first = q; 
        } else { 
            d->last->next_bin = q; 
        }
        d_prev = d->last;
        d->last = q;

    }

    // restaura o prev
    s->last->next_bin = s_prev;

    // faz o ultimo apontar d para ao previo
    d->last->next_bin = d_prev;

    //printf("SHALLOW COPY: P = %p\n",d);

}


//----------------------
//
//
//
//
static void _prepare(int op, void *content,  PContentData pcd) {
    PContent pc = (PContent) content;
    PBinListParams pblp = (PBinListParams) pcd->params;

    if (op == TERMINAL_OP_INIT) {
        pc->bin_size = pcd->bin_size;
        // xprintf(" [PREPARE %p %d] ", pbl, pbl->data.bin_size); fflush(stdout);
    }
}

//----------------------
//
//
//
//
static void _parse_param(int id_param, char *s, PByte params) {
    // xprintf("BINLIST ParseParam:\n");
    PBinListParams pblp = (PBinListParams) params;
    if (id_param == 1) {
        pblp->list_bin_size = atoi(s);
        // xprintf("BIN LIST: BinSize %d\n", pblp->list_bin_size); fflush(stdout);
        if (!pblp->list_bin_size) fatal("BINLIST: BinSize Error. ");
    } else {
        fatal("BINLIST: Extra parameter 1 %d\n",id_param);        
    }
}

/*-----------------
*
*
*
*/
static int _find_bounds(PByte pdata, int *bounds) {
    PBinList pbl = (PBinList) pdata;

    PBinNode p = pbl->first;
    if (!p) return 0; 

    bounds[0] = (p->items[0].id_bin -1) * pbl->data.bin_size;

    while (p->next_bin) p = p->next_bin;

    // deve achar o ultimo 
    PBinItem pbi = p->items;
    do {
        bounds[1] = pbi->id_bin;
        pbi ++;
    } while (pbi->id_bin);
    bounds[1] = (bounds[1] - 1) * pbl->data.bin_size;

    return 1;
}


//----------------------
//
//
//
//
static void register_content_binlist(PClass pclass) {

    static ContentFunctions cfs;
    cfs.parse_param = _parse_param;
    cfs.prepare = _prepare;
    cfs.shallow_copy = _shallow_copy;
    cfs.insert = &binlist_insert;
    cfs.remove = &binlist_remove;
    cfs.find_bounds = &_find_bounds;
    // cfs.remove

    static ContentInfo ci;
    memset(&ci, 0, sizeof(ContentInfo));

    ci.n_param_fields = 1;
    ci.min_params = 1;
    ci.max_params = 1;
    ci.params_size = sizeof(BParams);
    ci.private_size = sizeof(BinList);
    ci.pclass = pclass;

    ci.pcfs = &cfs;

    register_content("binlist_addonly", &ci);
}

//=============================================================================================
//
//    
//
//=============================================================================================

static int end_of_data;
#define END_OF_DATA (&end_of_data)


typedef struct {
    PBinNode pbn;
    PBinItem pbi;
    int cur_item;
} State, *PState;

static State state;

/*-----------------
*
*
*
*/
static void *cop_between(PQArgs pa, PQOpData pdata, void **ppstate) {
#if 0    
    //xprintf("COP BETWEEN: First %p\n",pdata);
     if (*ppstate == END_OF_DATA) return NULL;

    PBinList pbl = (PBinList) pdata;

    PState p = *ppstate;
    if (!p) {
        // xprintf("BETWEEN: First\n");
        p = &state;
        p->pbn = pbl->first;
        p->pbi = p->pbn->items;
        p->cur_item = MAX_ITEMS_PER_NODE;
    } else {
        p->cur_item ++;
        if (p->cur_item < MAX_ITEMS_PER_NODE) {
            p->pbi ++;
            if (!p->pbi->id_bin) { *ppstate = END_OF_DATA; return NULL; }
        } else {
            p->pbn = p->pbn->next_bin;
            if (!p->pbn) { *ppstate = END_OF_DATA; return NULL; }
            p->pbi = p->pbn->items;
            p->cur_item = 0;
        }
    }

    //xprintf("1"); fflush(stdout);
    bin_t t0 = pa->args[0].i/pbl->data.bin_size + 1;
    bin_t t1 = pa->args[1].i/pbl->data.bin_size + 1;
    if (t0 == t1) t1 ++;
//    xprintf("t0 = %ld\n",t0);

    //xprintf("X"); fflush(stdout);
    // xprintf("BETWEEN: %d %d %p BIN: %d COunt: %d PBL Count %d  %d\n", t0, t1, p, p->id_bin, p->count, pbl->count, pbl->n_nodes);

    // localiza o inicio do between
    if (p->id_bin < t0) {
        do {
            // xprintf("P.BIN %d\n",p->id_bin);
            p = p->next_bin;
        } while (p && (p->id_bin < t0));
        if (!p) { *ppstate = END_OF_DATA; return NULL; }
    }

    // enquanto estiver 
    if ( (p->id_bin >= t0) && (p->id_bin <= t1)) {
        // xprintf("P.BIN FOUND %d\n",p->id_bin);
        *ppstate = p;
        return p->data;
    }

    // xprintf("END OF DATA\n");
    *ppstate = END_OF_DATA;
    return NULL;
#endif
}


/*-----------------
*
*
*
*/
static void *cog_between(PQArgs pa, PQOpData pdata, int *indexes, void **ppstate) {
#if 0    
    if (*ppstate == END_OF_DATA) return NULL;

    PBinList pbl = (PBinList) pdata;
    // xprintf("BETWEEN 0: %d %d %p %d\n", pa->args[0].i, pa->args[1].i,pdata, pbl->n_nodes);

    PBinNode p = *ppstate;
    if (!p) {
        // xprintf("BETWEEN: First\n");
        p =  pbl->first;
        // xprintf("Count: %d Size: %d\n", pbl->count, pbl->data.bin_size);
    } else {
        p = p->next_bin;
    }
    
    if (!p) { 
        // xprintf("X\n");
        *ppstate = END_OF_DATA; 
        return NULL; 
    }
  
    //xprintf(" G %d ",pbl->data.bin_size);fflush(stdout);
    bin_t t0 = pa->args[0].i/pbl->data.bin_size;
    bin_t t1 = pa->args[1].i/pbl->data.bin_size;
    if (t0 == t1) t1 ++;

    // xprintf("COG t0 = %ld\n",t0);
    //xprintf("X");fflush(stdout);
    
    // xprintf("BETWEEN: %d %d\n", t0, t1);

    // localiza o inicio do between
    while (p) {
        // xprintf("%d\n",p->id_bin);
        if ((p->id_bin >= t0)) break;
        p = p->next_bin;
    }
    if (!p) { *ppstate = END_OF_DATA; return NULL; }

    // xprintf("BETWEEN: %d %d\n", pa->args[0].i, pa->args[1].i);

    // enquanto estiver 
    if ( (p->id_bin >= t0) && (p->id_bin < t1)) {
        *ppstate = p;
        if (indexes) { 
            //indexes[0] = (p->id_bin   - t0) * pbl->data.bin_size; 
            indexes[0] = (p->id_bin   - t0);  // Posicao relativa aos bins
  //          xprintf("BINLIST: Index %d \n", indexes[0]);
        }
        // xprintf("OFFS: %d \n", p->id_bin);
        return p->data;
    }

    *ppstate = END_OF_DATA;
    return NULL;
#endif    
}

#define REGISTER_BINLIST_OP(X,S,Y)  \
    static QOpInfo qoi_##X;\
    qoi_##X.op = cop_##X;\
    qoi_##X.op_group_by = cog_##X;\
    qoi_##X.min_args = Y;\
    qoi_##X.max_args = MAX_ARGS;\
    qoi_##X.fmt = "II"   ;\
    register_op("binlist2", S, &qoi_##X)

/*-----------------
*
*
*
*/
static void register_ops(void) {
    REGISTER_BINLIST_OP(between,"between2",2);
    qoi_between.max_args = 2;
}


//=============================================================================================
//
//    CLASS 
//
//=============================================================================================

/*--------------------------
*
*
*
*/
static int get_distinct_info(void * cop, PQArgs pa, PByte params, int bin_size, int *distinct_count, int *distinct_base) {
    //xprintf("Z1\n"); fflush(stdout);
    PBinListParams pblp = (PBinListParams) params;

    if (cop == cop_between) {
        int begin = pa->args[0].i;
        int end   = pa->args[1].i;
        // xprintf("Z1 begin %d end %d\n", begin, end); fflush(stdout);
        
        //xprintf("BINLIST: %d\n", pblp->list_bin_size); fflush(stdout);

//        *distinct_count = ((end - begin) / pblp->list_bin_size); 
        *distinct_count = ((end - begin) / bin_size); 
        if (!*distinct_count) *distinct_count = 1;
        *distinct_base = begin;
        // xprintf("Z1\n"); fflush(stdout);

        return 1;
    }
    return 0;
}


/*--------------------------
*
*
*
*/
static void *create_op_data(void * cop, PQArgs pa) {

    if (cop == cop_between) {
        return calloc(1,sizeof(BinList));
    } 
    return NULL;
}

/*--------------------------
*
*
*
*/
static void destroy_op_data(void *cop, void *op_data) {
    // assume que o conteudo foi liberado
    if (op_data) free(op_data);
}

/*--------------------------
*
*
*
*/
void register_container_binlist_addonly(void) {

    // prevention against reinitialization during execution
    static int done = 0; 
    if (!done) done = 1; else return;
    
    static Class c;
    memset(&c, 0, sizeof(c));

    c.name = "binlist_addonly";
    c.class_type = CONTAINER_CLASS;

    c.n_group_by_indexes = 1;
    c.group_by_requires_rule = 1;  // was 0

    c.get_distinct_info = &get_distinct_info;

    c.create_op_data = &create_op_data;
    c.destroy_op_data = &destroy_op_data;

#if CLASS_PARSE
    c.n_fields = 1;
    c.n_params = 1;
    c.parse_param = _parse_param;
#endif

    register_class(&c);
    register_content_binlist(&c);
    register_ops();
}


